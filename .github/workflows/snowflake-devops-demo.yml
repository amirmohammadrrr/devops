name: Deploy Binary Database

on:
  push:
    branches:
      - '**'
    paths:
      - 'binary/**'
  pull_request:
    branches:
      - main
    paths:
      - 'binary/**'
  workflow_dispatch:

jobs:
  deploy-dev:
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8
      
      - name: Deploy to DEV_RAW_BINARY
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SF_ACCOUNT_DEV }}      # Changed: SF_ACCOUNT ‚Üí SNOWFLAKE_ACCOUNT
          SNOWFLAKE_USER: ${{ secrets.SF_USERNAME_DEV }}        # Changed: SF_USERNAME ‚Üí SNOWFLAKE_USER
          SNOWFLAKE_PASSWORD: ${{ secrets.SF_PASSWORD_DEV }}    # Changed: SF_PASSWORD ‚Üí SNOWFLAKE_PASSWORD
          SNOWFLAKE_ROLE: ${{ secrets.SF_ROLE }}                # Changed: SF_ROLE ‚Üí SNOWFLAKE_ROLE
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}      # Changed: SF_WAREHOUSE ‚Üí SNOWFLAKE_WAREHOUSE
          SNOWFLAKE_DATABASE: DEV_RAW_BINARY                    # Changed: SF_DATABASE ‚Üí SNOWFLAKE_DATABASE
        run: |
          echo "üöÄ Deploying to $SF_DATABASE"
          pip install schemachange
          
          schemachange -f binary \
            -c $SNOWFLAKE_DATABASE.SCHEMACHANGE.CHANGE_HISTORY \   # Changed
            --create-change-history-table
          
          echo "‚úÖ Deployed to $SF_DATABASE"

  deploy-qa:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8
      
      - name: Deploy to QA_RAW_BINARY
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SF_ACCOUNT_DEV }}
          SNOWFLAKE_USER: ${{ secrets.SF_USERNAME_DEV }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SF_PASSWORD_DEV }}
          SNOWFLAKE_ROLE: ${{ secrets.SF_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SNOWFLAKE_DATABASE: QA_RAW_BINARY
        run: |
          echo "üß™ Deploying to $SF_DATABASE"
          pip install schemachange
          
          schemachange -f binary \
            -c $SNOWFLAKE_DATABASE.SCHEMACHANGE.CHANGE_HISTORY \   # Changed
            --create-change-history-table
          
          echo "‚úÖ Deployed to $SF_DATABASE"

  deploy-prod:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: PROD
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8
      
      - name: Deploy to PROD_RAW_BINARY
        env:
          SF_ACCOUNT: ${{ secrets.SF_ACCOUNT_PROD }}
          SF_USERNAME: ${{ secrets.SF_USERNAME_PROD }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD_PROD }}
          SF_ROLE: ${{ secrets.SF_ROLE }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SF_DATABASE: PROD_RAW_BINARY  # ‚Üê Specific to this workflow
        run: |
          echo "üöÄ Deploying to $SF_DATABASE"
          pip install schemachange
          
          schemachange -f binary \
            -a $SF_ACCOUNT \
            -u $SF_USERNAME \
            -r $SF_ROLE \
            -w $SF_WAREHOUSE \
            -d $SF_DATABASE \
            -c $SF_DATABASE.SCHEMACHANGE.CHANGE_HISTORY \
            --create-change-history-table
          
          echo "‚úÖ Deployed to $SF_DATABASE"
