name: Deploy Binary Database
on:
  push:
    branches:
      - '**'
    paths:
      - 'binary/**'
  pull_request:
    branches:
      - main
    paths:
      - 'binary/**'
  workflow_dispatch:

jobs:
  deploy-dev:
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8
      
      - name: Deploy to DEV_RAW_BINARY
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SF_ACCOUNT_DEV }}
          SNOWFLAKE_USER: ${{ secrets.SF_USERNAME_DEV }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SF_PASSWORD_DEV }}
          SNOWFLAKE_ROLE: ${{ secrets.SF_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SNOWFLAKE_DATABASE: DEV_RAW_BINARY
        run: |
          echo "ðŸš€ Deploying to $SNOWFLAKE_DATABASE"
          pip install schemachange
          
          schemachange -f binary \
            -c $SNOWFLAKE_DATABASE.SCHEMACHANGE.CHANGE_HISTORY \
            --create-change-history-table
          
          echo "âœ… Deployed to $SNOWFLAKE_DATABASE"

  deploy-qa:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8
      
      - name: Deploy to QA_RAW_BINARY
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SF_ACCOUNT_DEV }}
          SNOWFLAKE_USER: ${{ secrets.SF_USERNAME_DEV }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SF_PASSWORD_DEV }}
          SNOWFLAKE_ROLE: ${{ secrets.SF_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SNOWFLAKE_DATABASE: QA_RAW_BINARY
        run: |
          echo "ðŸ§ª Deploying to $SNOWFLAKE_DATABASE"
          pip install schemachange
          
          schemachange -f binary \
            -c $SNOWFLAKE_DATABASE.SCHEMACHANGE.CHANGE_HISTORY \
            --create-change-history-table
          
          echo "âœ… Deployed to $SNOWFLAKE_DATABASE"

  deploy-prod:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: PROD
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8
      
      - name: Deploy to PROD_RAW_BINARY
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SF_ACCOUNT_PROD }}
          SNOWFLAKE_USER: ${{ secrets.SF_USERNAME_PROD }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SF_PASSWORD_PROD }}
          SNOWFLAKE_ROLE: ${{ secrets.SF_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SNOWFLAKE_DATABASE: PROD_RAW_BINARY
        run: |
          echo "ðŸš€ Deploying to $SNOWFLAKE_DATABASE"
          pip install schemachange
          
          schemachange -f binary \
            -c $SNOWFLAKE_DATABASE.SCHEMACHANGE.CHANGE_HISTORY \
            --create-change-history-table
          
          echo "âœ… Deployed to $SNOWFLAKE_DATABASE"
