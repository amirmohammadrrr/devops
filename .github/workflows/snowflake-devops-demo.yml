name: Deploy Binary Database

on:
  push:
    branches:
      - '**'
    paths:
      - 'binary/**'
  pull_request:
    branches:
      - main
    paths:
      - 'binary/**'
  workflow_dispatch:

jobs:
  ###########################################
  # DEV (runs on any push NOT to main)
  ###########################################
  deploy-dev:
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Deploy to DEV_RAW_BINARY
        env:
          SNOWFLAKE_ACCOUNT:   ${{ secrets.SF_ACCOUNT_DEV }}
          SNOWFLAKE_USER:      ${{ secrets.SF_USERNAME_DEV }}
          SNOWFLAKE_PASSWORD:  ${{ secrets.SF_PASSWORD_DEV }}
          SNOWFLAKE_ROLE:      ${{ secrets.SF_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
        run: |
          pip install schemachange
          schemachange deploy -f binary -c dev --create-change-history-table
          echo "âœ… Deployed to DEV"

  ###########################################
  # QA (runs when a PR is opened against main)
  ###########################################
  deploy-qa:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Deploy to QA_RAW_BINARY
        env:
          SNOWFLAKE_ACCOUNT:   ${{ secrets.SF_ACCOUNT_DEV }}
          SNOWFLAKE_USER:      ${{ secrets.SF_USERNAME_DEV }}
          SNOWFLAKE_PASSWORD:  ${{ secrets.SF_PASSWORD_DEV }}
          SNOWFLAKE_ROLE:      ${{ secrets.SF_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
        run: |
          pip install schemachange
          schemachange deploy -f binary -c qa --create-change-history-table
          echo "ðŸ§ª Deployed to QA"

  ###########################################
  # PROD (runs ONLY on push to main)
  ###########################################
  deploy-prod:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: PROD

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Deploy to PROD_RAW_BINARY
        env:
          SNOWFLAKE_ACCOUNT:   ${{ secrets.SF_ACCOUNT_PROD }}
          SNOWFLAKE_USER:      ${{ secrets.SF_USERNAME_PROD }}
          SNOWFLAKE_PASSWORD:  ${{ secrets.SF_PASSWORD_PROD }}
          SNOWFLAKE_ROLE:      ${{ secrets.SF_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
        run: |
          pip install schemachange
          schemachange deploy -f binary -c prod --create-change-history-table
          echo "ðŸš€ Deployed to PROD"
